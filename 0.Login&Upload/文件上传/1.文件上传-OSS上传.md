### 文件云上传

1. `pom.xml`引入阿里云OSS依赖
```xml
<!--        阿里云OSS依赖-->
        <dependency>
            <groupId>com.aliyun.oss</groupId>
            <artifactId>aliyun-sdk-oss</artifactId>
            <version>3.18.4</version>
        </dependency>
        <dependency>
            <groupId>javax.xml.bind</groupId>
            <artifactId>jaxb-api</artifactId>
            <version>2.3.1</version>
        </dependency>
        <dependency>
            <groupId>javax.activation</groupId>
            <artifactId>activation</artifactId>
            <version>1.1.1</version>
        </dependency>
        <!-- no more than 2.3.3-->
        <dependency>
            <groupId>org.glassfish.jaxb</groupId>
            <artifactId>jaxb-runtime</artifactId>
            <version>2.3.3</version>
        </dependency>
<!--        阿里云OSS依赖-完-->
```

2. 引入阿里云OSS上传的工具类(由官方文档示例代码改造而来)：
   - 以下为改造后的代码。原示例代码请移步[官方文档](https://help.aliyun.com/zh/oss/developer-reference/simple-upload-11?spm=a2c4g.11186623.help-menu-31815.d_1_1_1_1_0_0.5d3b39c3Kv2KfG "简单上传")
   - 此处为了方便代码模板，所以直接为几个属性进行赋值。实际的赋值流程应该是通过`properties`封装类加上`yml`来进行配置赋值。
     - 如果要进一步解耦的话，应该再创建一个`@Configuration`的配置类，来专门负责为AliyunOSSOperator进行参数的赋值加Bean处理，具体代码可以参考**苍穹外卖 config/AliOssConfiguration**
```java
    public class AliyunOSSOperator {

        private String endpoint = "https://oss-cn-shanghai.aliyuncs.com";
        private String bucketName = "java-practice-sean";
        private String region = "cn-shanghai";

        public String upload(MultipartFile file) throws com.aliyuncs.exceptions.ClientException, IOException {

            // 1. 从环境变量中获取访问凭证。运行本代码示例之前，请确保已设置环境变量OSS_ACCESS_KEY_ID和OSS_ACCESS_KEY_SECRET。
            EnvironmentVariableCredentialsProvider credentialsProvider = CredentialsProviderFactory.newEnvironmentVariableCredentialsProvider();

            // 2. 组装文件名，也就是上传后的文件名，自定义即可
            String originalFile = file.getOriginalFilename();
            String extension = "";
            //判定原文件是否有"."
            if (originalFile != null) {
                int dot = originalFile.lastIndexOf(".");
                if (dot != -1 && dot != originalFile.length() - 1) {
                    extension = originalFile.substring(dot);
                }
            }
            String fileName = UUID.randomUUID() + extension;

            // 3. 可选：生成文件夹名，这里用日期
            String dir = LocalDate.now().format(DateTimeFormatter.ofPattern("yyyy/MM"));
            // 4. 组装object名
            String objectName = dir + "/" + fileName;

            // 创建OSSClient实例。
            // 当OSSClient实例不再使用时，调用shutdown方法以释放资源。
            ClientBuilderConfiguration clientBuilderConfiguration = new ClientBuilderConfiguration();
            clientBuilderConfiguration.setSignatureVersion(SignVersion.V4);
            OSS ossClient = OSSClientBuilder.create()
                    .endpoint(endpoint)
                    .credentialsProvider(credentialsProvider)
                    .clientConfiguration(clientBuilderConfiguration)
                    .region(region)
                    .build();
            // 5. 获取文件的inputStream，用这种try()书写的话，可以省略 .close()关闭流的代码，并且会自动在正确的时机关闭
            try(InputStream fileInputStream = file.getInputStream()){

                // 创建PutObjectRequest对象。
                PutObjectRequest putObjectRequest = new PutObjectRequest(bucketName, objectName, fileInputStream);

                // 如果需要上传时设置存储类型和访问权限，请参考以下示例代码。
                // ObjectMetadata metadata = new ObjectMetadata();
                // metadata.setHeader(OSSHeaders.OSS_STORAGE_CLASS, StorageClass.Standard.toString());
                // metadata.setObjectAcl(CannedAccessControlList.Private);
                // putObjectRequest.setMetadata(metadata);

                // 上传文件。
                ossClient.putObject(putObjectRequest);

            } catch (OSSException | ClientException e) {
                throw new ServiceException("OSS upload failed: " + e.getMessage(), e);

            } finally {
                if (ossClient != null) {
                    ossClient.shutdown();
                }
            }
            // 6. 返回云端文件路径url，让前端进行渲染
            String[] split = endpoint.split("//");
            return split[0] + "//" + bucketName + "." + split[1] + "/" + objectName;
        }
    }
```

1. 上传文件功能的接口开发：